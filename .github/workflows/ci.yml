name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install ruff
        run: python -m pip install --upgrade pip && pip install ruff
      - name: Run ruff
        run: ruff check .

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install mypy
        run: python -m pip install --upgrade pip && pip install mypy
      - name: Run mypy
        run: mypy . || true

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install safety
        run: python -m pip install --upgrade pip && pip install safety
      - name: Run safety check
        run: |
          if [ -f requirements.txt ]; then safety check --file=requirements.txt || true; else echo "No requirements.txt"; fi

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.12]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install pytest requests fastapi uvicorn pydantic email-validator

    - name: Run tests
      run: |
        # Start the app in background so tests that use HTTP can reach it
        nohup python -m uvicorn main:app --host 127.0.0.1 --port 8000 &
        # wait for server to start
        for i in {1..10}; do
          if curl -sSf http://127.0.0.1:8000/health >/dev/null 2>&1; then
            break
          fi
          sleep 1
        done
        pytest -q
